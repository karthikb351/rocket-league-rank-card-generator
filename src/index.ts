import * as express from 'express';
const chromium = require('chrome-aws-lambda');
import {getRankDataFromTrackerGG} from './api';

const app = express();

app.get('/rank/:platform/:id', async (req, res) => {
  res.send(
    await (
      await getRankDataFromTrackerGG(req.params.platform, req.params.id)
    ).data
  );
});

app.get('/', async (req, res) => {
  const browser = await chromium.puppeteer.launch({
    args: chromium.args,
    defaultViewport: chromium.defaultViewport,
    executablePath: await chromium.executablePath,
    headless: true,
    ignoreHTTPSErrors: true,
  });
  console.log('launched');
  const page = await browser.newPage();
  console.log('opened page');
  await page.setContent(
    '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"> <style type="text/css"> body { width: 100% !important; height: 100% !important; margin: 0; padding: 0; } .ReadMsgBody { width: 100%; } .ExternalClass { width: 100%; } html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video { Margin: 0; padding: 0; border: 0; } /* HTML5 display-role reset for older browsers */ article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section { display: block; } body { line-height: 1; } blockquote, q { quotes: none; } blockquote:before, blockquote:after, q:before, q:after { content: \'\'; content: none; } table { border-collapse: collapse; border-spacing: 0; } table, td { mso-table-lspace: 0pt; mso-table-rspace: 0pt; } @media only screen and (max-width: 479px), only screen and (max-device-width: 479px) { body { width: auto !important; } #conteneur { width: 100% !important; } .mobilehiddenmodule { display: none !important; } .hiddenmodule { display: block !important; width: Auto !important; height: Auto !important; } #table_global { width: 100% !important; } .full { display: block !important; } .contenu { font-size: 12px !important; } .mobile-full-width { width: 100% !important; } td.full { display: block !important; } img { max-width: 100% !important; height: auto !important; } } </style> <!--[if !mso]><!--> <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Dancing+Script|Droid+Sans|Lato|Lobster|Montserrat|Open+Sans|Pacifico|Raleway|Roboto|Source+Sans+Pro|Titillium+Web&amp;subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext,vietnamese" rel="stylesheet" type="text/css"> <style type="text/css"> @import url(https://fonts.googleapis.com/css?family=Bree+Serif|Dancing+Script|Droid+Sans|Lato|Lobster|Montserrat|Open+Sans|Pacifico|Raleway|Roboto|Source+Sans+Pro|Titillium+Web&amp;subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext,vietnamese); </style> <!--<![endif]--> <!--[if gte mso 9]> <style> li { text-indent: -1em; } </style> <xml> <o:OfficeDocumentSettings> <o:AllowPNG/> <o:PixelsPerInch>96</o:PixelsPerInch> </o:OfficeDocumentSettings> </xml> <![endif]--> <title></title> </head> <body scroll="no" id="conteneur" style="width:100%; background-color:#ffffff;"> <!--<div class="email-builder__modal-backdrop fade in"></div>--> <table width="100%" cellpadding="0" cellspacing="0"> <tr> <td align="center"> <table cellpadding="0" cellspacing="0" align="center" > <tr> <td align="left" valign="top"> <!-- STRUCTURE CONTAINER BEGIN --> <table class="structure-container" width="100%" cellpadding="0" cellspacing="0" style=" background-color: #ffffff; "> <tr> <td> <!-- STRUCTURE BEGIN --> <table cellpadding="0" cellspacing="0" > <tr> <td width="10" style=" "> </td> <td align="center" width="650" > <table align="center" cellpadding="0" cellspacing="0" class="structure mobile-full-width" width="100%" style=" border-color: #156ba5; "> <tr> <td align="center"> <table align="center" class="mobile-full-width" cellpadding="0" cellspacing="0" width="100%" > <td class="full mobile-full-width" valign=" top " width="100%" style=" valign: top; "> <table class="column" width="100%" cellpadding="0" cellspacing="0" style="margin: 0 auto; text-align: left"> <tr> <td align="center" style=" padding: 20px 20px 5px 20px;"> <table width="100%" align="left" cellpadding="0" cellspacing="0"> <tr> <td align="left"> <p style="color: #393939; font-size: 10px; font-family: Arial; line-height: 14px;text-align: center; margin: 0;mso-line-height-rule: exactly;">Pour consulter la version en ligne, <a style="color: #393939; font-size: 10px; font-family: Arial; line-height: 14px;text-align: center; margin: 0; color: #393939 !important; text-decoration : underline; font-size: inherit; font-family: inherit;mso-line-height-rule: exactly;" href="{{tracking.webcopy}}" target="_blank" rel="noopener"> cliquez ici </a></p> </td> </tr> </table> </td> </tr> </table> </td> </table> </td> </tr> </table> </td> <td width="10" style=" "> </td> </tr> </table> <!-- STRUCTURE END --> <!-- SPACE BETWEEN STRUCTURES START --> <!-- SPACE BETWEEN STRUCTURES END --> </td> </tr> </table> <!-- STRUCTURE CONTAINER END --> <!-- STRUCTURE CONTAINER BEGIN --> <table class="structure-container" width="100%" cellpadding="0" cellspacing="0" style=" "> <tr> <td> <table class="space-start" width="100%" cellpadding="0" cellspacing="0"> <tr> <td height="10" style=" padding: 0 10px; background: #ffffff; line-height: 10px;" width="650"> </td> </tr> </table> <!-- STRUCTURE BEGIN --> <table cellpadding="0" cellspacing="0" > <tr> <td width="10" style=" background: #ffffff; "> </td> <td align="center" width="650" > <table align="center" cellpadding="0" cellspacing="0" class="structure mobile-full-width" width="100%" style=" background-color: #ffffff; border-color: #156ba5; "> <tr> <td align="center"> <table align="center" class="mobile-full-width" cellpadding="0" cellspacing="0" width="100%" > <td class="full mobile-full-width" valign=" top " width="100%" style=" valign: top; "> <table class="column" width="100%" cellpadding="0" cellspacing="0" style="margin: 0 auto; text-align: left"> <tr> <td align="center" style=" padding: 20px 20px 20px 20px;"> <table width="100%" align="left" cellpadding="0" cellspacing="0"> <tr> <td align="left"> <p style="color: #393939; font-size: 17px; font-family: Arial; line-height: 26px;text-align: left; margin: 0;mso-line-height-rule: exactly;">Hacque adfabilitate confisus cum eadem postridie feceris, ut incognitus haerebis et repentinus, hortatore illo hesterno clientes numerando, qui sis vel unde venias diutius ambigente agnitus vero tandem et adscitus in amicitiam si te salutandi.</p> </td> </tr> </table> </td> </tr> </table> </td> </table> </td> </tr> </table> </td> <td width="10" style=" background: #ffffff; "> </td> </tr> </table> <!-- STRUCTURE END --> <!-- SPACE BETWEEN STRUCTURES START --> <table class="space-end" width="100%" cellpadding="0" cellspacing="0"> <tr> <td height="10" style=" padding: 0 10px; background: #ffffff; line-height: 10px;" width="650"> </table> <!-- SPACE BETWEEN STRUCTURES END --> </td> </tr> </table> <!-- STRUCTURE CONTAINER END --> <!-- STRUCTURE CONTAINER BEGIN --> <table class="structure-container" width="100%" cellpadding="0" cellspacing="0" style=" background-color: #ffffff; "> <tr> <td> <!-- STRUCTURE BEGIN --> <table cellpadding="0" cellspacing="0" > <tr> <td width="10" style=" "> </td> <td align="center" width="650" > <table align="center" cellpadding="0" cellspacing="0" class="structure mobile-full-width" width="100%" style=" border-color: #156ba5; "> <tr> <td align="center"> <table align="center" class="mobile-full-width" cellpadding="0" cellspacing="0" width="100%" > <td class="full mobile-full-width" valign=" top " width="100%" style=" valign: top; "> <table class="column" width="100%" cellpadding="0" cellspacing="0" style="margin: 0 auto; text-align: left"> <tr> <td align="center" style=" padding: 20px 20px 20px 20px;"> <table width="100%" align="left" cellpadding="0" cellspacing="0"> <tr> <td align="left"> <p style="color: #393939; font-size: 10px; font-family: Arial; line-height: 14px;text-align: center; margin: 0;mso-line-height-rule: exactly;"><a style="color: #393939; font-size: 10px; font-family: Arial; line-height: 14px;text-align: center; margin: 0; color: #393939 !important; text-decoration : underline; font-size: inherit; font-family: inherit;mso-line-height-rule: exactly;" href="{{tracking.unsubscribe}}" target="_blank" rel="noopener"> Cliquez sur ce lien pour vous d&eacute;sabonner </a></p> </td> </tr> </table> </td> </tr> </table> </td> </table> </td> </tr> </table> </td> <td width="10" style=" "> </td> </tr> </table> <!-- STRUCTURE END --> <!-- SPACE BETWEEN STRUCTURES START --> <!-- SPACE BETWEEN STRUCTURES END --> </td> </tr> </table> <!-- STRUCTURE CONTAINER END --> </td> </tr> </table> </td> </tr> </table> </body> </html>'
  );
  console.log('set content');
  res.type('png');
  res.send(await page.screenshot());
});

exports.app = app;
